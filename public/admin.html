<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ADMIN THEME (Matches Index) --- */
        :root {
            --bg-color: #000000; 
            --surface-color: #121212;
            --surface-container: #1E1E1E;
            --surface-high: #2C2C2C;
            --surface-highest: #383838;
            
            --primary: #D0BCFF;
            --on-primary: #381E72;
            --primary-container: #4F378B;
            
            --tertiary: #FFB0CD; 
            --error: #F2B8B5; --on-error: #601410;
            --success: #A6D6A8; --on-success: #0C3B2E;
            
            --text-main: #FFFFFF;       
            --text-muted: #E6E0E9; 
            
            --radius-lg: 24px;
            --radius-pill: 999px;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; padding: 20px; 
            background: var(--bg-color); 
            color: var(--text-main);
            text-align: center; 
        }

        h1 { margin-bottom: 25px; font-weight: 800; letter-spacing: -0.5px; }
        h3 { margin-top: 0; border-bottom: 1px solid var(--surface-highest); padding-bottom: 15px; color: var(--primary); font-size: 1.1rem; }

        /* PANELS */
        .panel-box { 
            background: var(--surface-container); padding: 24px; 
            border-radius: var(--radius-lg); margin: 0 auto 25px auto; 
            max-width: 600px; text-align: left;
            border: 1px solid var(--surface-highest);
        }

        /* INPUTS */
        input { 
            background: var(--surface-highest); border: 1px solid #444;
            color: white; padding: 10px 16px; border-radius: var(--radius-pill); 
            margin: 5px; font-size: 0.95rem; outline: none; font-family: 'Roboto', sans-serif;
        }
        input:focus { border-color: var(--primary); background: var(--surface-high); }
        
        input.score-in { width: 50px; text-align: center; font-weight: bold; }
        input.live-in { width: 80px; text-align: center; font-weight: 900; font-size: 1.5rem; height: 50px; }
        input.cost-in { width: 70px; text-align: center; }
        
        /* Color Picker & Hex Input */
        input.color-picker { width: 50px; height: 42px; padding: 0; border: none; border-radius: 12px; overflow: hidden; vertical-align: middle; cursor: pointer; }
        input.hex-in { width: 90px; font-family: monospace; text-transform: uppercase; letter-spacing: 1px; }

        /* BUTTONS */
        button { 
            padding: 10px 24px; cursor: pointer; border: none; 
            border-radius: 50px; font-weight: 700; font-size: 0.9rem;
            transition: transform 0.1s, filter 0.1s; margin: 5px;
            font-family: 'Roboto', sans-serif;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        button.primary { background: var(--primary); color: var(--on-primary); } 
        button.red { background: var(--error); color: var(--on-error); }
        button.green { background: var(--success); color: var(--on-success); }
        button.orange { background: var(--tertiary); color: #3E001D; }
        button.yellow { background: #FFD700; color: black; }
        button.small-btn { padding: 5px 12px; font-size: 0.8rem; background: var(--surface-high); color: #CCC; }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(11, 34px); gap: 3px; justify-content: center; margin-top: 15px; }
        .cell { 
            width: 34px; height: 34px; background: var(--surface-high); 
            color: #888; font-size: 10px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; border-radius: 8px; font-weight: 500;
        }
        .cell:hover { background: var(--primary); color: var(--on-primary); }
        .cell.taken { background: var(--primary-container); color: #EADDFF; border: 1px solid #555; }
        .cell.header { background: black; color: white; cursor: default; font-weight: bold; border: none; }

        /* CHIPS & LAYOUT */
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .name-chip { background: var(--surface-highest); padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #555; }
        .name-chip:hover { background: var(--surface-high); }
        .name-chip.active { background: var(--primary); color: var(--on-primary); border-color: var(--primary); font-weight: bold; }

        .score-row { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; }
        .team-col { display: flex; flex-direction: column; align-items: center; }
        .quick-add { display: flex; gap: 5px; margin-top: 5px; }

        .login-box { 
            background: var(--surface-container); color: white; max-width: 350px; 
            margin: 100px auto; padding: 40px; border-radius: 28px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333;
        }
        .row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .label { min-width: 80px; font-weight: 700; color: #CCC; }
        
        /* Stats Table */
        table.stats { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        table.stats th { text-align: left; color: #BBB; padding: 12px 8px; border-bottom: 1px solid #444; }
        table.stats td { padding: 10px 8px; border-bottom: 1px solid #333; color: #EEE; }
        
        .status-badge { cursor: pointer; font-size: 1.1rem; user-select: none; }
        .unpaid { filter: grayscale(100%); opacity: 0.5; } 
        .paid { text-shadow: 0 0 10px rgba(166, 214, 168, 0.4); }   
    </style>
</head>
<body>

    <div id="login-screen" class="login-box">
        <h2 style="margin-top:0; color:var(--primary);">Admin Login</h2>
        <input type="password" id="password-input" placeholder="Password" style="width: 80%; margin-bottom: 20px;" onkeyup="if(event.key === 'Enter') checkPass()">
        <br>
        <button class="primary" onclick="checkPass()">Unlock Panel</button>
    </div>

    <div id="admin-ui" style="display:none;">
        <h1>Admin Control Panel</h1>
        
        <div class="panel-box" style="border-color: var(--primary);">
            <h3>üî¥ Live Game Tracker</h3>
            <div class="score-row">
                <div class="team-col">
                    <span id="live-name-top" style="font-weight:bold; color:#AAA; margin-bottom:5px;">TOP</span>
                    <input type="number" id="live-top" class="live-in" value="0" onchange="syncLive()">
                    <div class="quick-add">
                        <button class="small-btn" onclick="adjScore('top', 1)">+1</button>
                        <button class="small-btn" onclick="adjScore('top', 3)">+3</button>
                        <button class="small-btn" onclick="adjScore('top', 6)">+6</button>
                    </div>
                </div>
                <div style="font-size:2rem; font-weight:100; color:#555;">-</div>
                <div class="team-col">
                    <span id="live-name-left" style="font-weight:bold; color:#AAA; margin-bottom:5px;">LEFT</span>
                    <input type="number" id="live-left" class="live-in" value="0" onchange="syncLive()">
                    <div class="quick-add">
                        <button class="small-btn" onclick="adjScore('left', 1)">+1</button>
                        <button class="small-btn" onclick="adjScore('left', 3)">+3</button>
                        <button class="small-btn" onclick="adjScore('left', 6)">+6</button>
                    </div>
                </div>
            </div>
            <div style="text-align:center; padding-top:10px; border-top:1px solid #333;">
                <button id="set-quarter-btn" class="primary" onclick="submitToQuarter()">Submit as Q1 Final</button>
                <div style="font-size:0.8rem; color:#777; margin-top:5px;">Does not reset live score (rollover)</div>
            </div>
        </div>

        <div class="panel-box">
            <h3>2. Game Settings</h3>
            <div style="text-align:center; margin-bottom:15px;">
                <button id="lock-btn" class="red" onclick="toggleLock(true)">üîí LOCK GAME</button>
                <button id="unlock-btn" class="green" onclick="toggleLock(false)">üîì UNLOCK GAME</button>
            </div>
            <div class="row">
                <span class="label">Top Team:</span>
                <input type="text" id="team-top" style="width:100px;" placeholder="Name">
                <input type="color" id="color-top" class="color-picker" oninput="document.getElementById('hex-top').value=this.value">
                <input type="text" id="hex-top" style="width:70px;" placeholder="#000000">
            </div>
            <div class="row">
                <span class="label">Left Team:</span>
                <input type="text" id="team-left" style="width:100px;" placeholder="Name">
                <input type="color" id="color-left" class="color-picker" oninput="document.getElementById('hex-left').value=this.value">
                <input type="text" id="hex-left" style="width:70px;" placeholder="#000000">
            </div>
            <div class="row">
                <span class="label">Cost:</span> <input type="number" id="cost-input" class="cost-in" value="5">
                <button class="primary" onclick="saveSettings()">Save All</button>
            </div>
        </div>

        <div class="panel-box">
            <h3>3. Scoreboard (Edits)</h3>
            <table style="width:100%; color:white;">
                <tr><td></td><td class="label">TOP</td><td class="label">LEFT</td></tr>
                <tr><td>Q1</td><td><input class="score-in" id="s-q1-top"></td><td><input class="score-in" id="s-q1-left"></td></tr>
                <tr><td>Q2</td><td><input class="score-in" id="s-q2-top"></td><td><input class="score-in" id="s-q2-left"></td></tr>
                <tr><td>Q3</td><td><input class="score-in" id="s-q3-top"></td><td><input class="score-in" id="s-q3-left"></td></tr>
                <tr><td>Final</td><td><input class="score-in" id="s-final-top"></td><td><input class="score-in" id="s-final-left"></td></tr>
            </table>
            <div style="text-align:right; margin-top:10px;">
                <button class="orange" onclick="clearScores()">Clear All</button>
                <button class="green" onclick="saveScores()">Update</button>
            </div>
        </div>

        <div class="panel-box">
            <h3>4. Money & Stats</h3>
            <div id="stats-container"></div>
            <div id="payout-info" style="margin-top:15px; padding-top:10px; border-top:1px dashed #555; font-size:0.9rem; color:#888;"></div>
        </div>

        <div class="panel-box">
            <h3>5. Grid & Names</h3>
            
            <div style="font-size:0.85rem; color:#888; margin-bottom:8px;">Quick Select (Tap name, then tap empty squares):</div>
            <div id="quick-fill-chips" class="chip-container"></div>
            <input type="text" id="custom-assign-name" placeholder="Or type new name..." style="width:60%; margin-bottom:15px;">

            <div style="text-align:center; margin-bottom:10px;">
                <button class="orange" onclick="randomize()">üé≤ Randomize #s</button>
                <button class="yellow" onclick="resetHeaders()">‚ùì Reset #s</button>
            </div>
            
            <div id="mini-grid" class="grid"></div>
            
            <div style="text-align:center; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
                <button class="red" onclick="resetBoard()">‚ö†Ô∏è WIPE BOARD</button>
            </div>
        </div>
        
        <br>
        <a href="/" style="color:var(--primary); text-decoration:none; font-weight:bold;">‚Üê Back to Public Board</a>
    </div>

    <script>
        let storedPass = ""; 
        let activeQuickName = null;
        let globalData = null;

        // Ensure DOM is ready
        window.onload = function() {
            const savedPass = localStorage.getItem('squaresAdminPass');
            if (savedPass) {
                document.getElementById('password-input').value = savedPass;
                checkPass(); 
            }
        };

        async function checkPass() {
            const p = document.getElementById('password-input').value;
            try {
                const res = await fetch('/api/admin/verify', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:p}) });
                if (res.ok) {
                    storedPass = p;
                    localStorage.setItem('squaresAdminPass', p);
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('admin-ui').style.display = 'block';
                    loadAdmin();
                } else {
                    alert("Incorrect Password");
                    localStorage.removeItem('squaresAdminPass'); 
                }
            } catch (e) {
                console.error("Login failed:", e);
                alert("Server connection failed. Is the server running?");
            }
        }

        async function loadAdmin() {
            try {
                const res = await fetch('/api/squares');
                globalData = await res.json();
                const d = globalData;
                
                // Live Tracker
                document.getElementById('live-name-top').innerText = d.teamTop || "TOP";
                document.getElementById('live-name-left').innerText = d.teamLeft || "LEFT";
                document.getElementById('live-top').value = d.liveTop || 0;
                document.getElementById('live-left').value = d.liveLeft || 0;

                // Settings
                document.getElementById('team-top').value = d.teamTop;
                document.getElementById('team-left').value = d.teamLeft;
                document.getElementById('cost-input').value = d.cost;
                document.getElementById('color-top').value = d.colorTop;
                document.getElementById('hex-top').value = d.colorTop;
                document.getElementById('color-left').value = d.colorLeft;
                document.getElementById('hex-left').value = d.colorLeft;
                document.getElementById('lock-btn').style.display = d.isLocked ? 'none' : 'inline-block';
                document.getElementById('unlock-btn').style.display = d.isLocked ? 'inline-block' : 'none';

                // Scores
                ['q1','q2','q3','final'].forEach(q => {
                    document.getElementById(`s-${q}-top`).value = d.scores[q].top;
                    document.getElementById(`s-${q}-left`).value = d.scores[q].left;
                });

                updateNextQuarterButton(d.scores);
                renderGrid(d);
                renderQuickChips(d.squares);
                renderStats(d.squares, d.cost);
            } catch (e) {
                console.error("Error loading admin data:", e);
            }
        }

        function updateNextQuarterButton(scores) {
            const btn = document.getElementById('set-quarter-btn');
            if(scores.q1.top === '') { btn.innerText = "Submit as Q1 Final"; btn.setAttribute('data-q', 'q1'); }
            else if(scores.q2.top === '') { btn.innerText = "Submit as Q2 Final"; btn.setAttribute('data-q', 'q2'); }
            else if(scores.q3.top === '') { btn.innerText = "Submit as Q3 Final"; btn.setAttribute('data-q', 'q3'); }
            else { btn.innerText = "Submit as Final Game"; btn.setAttribute('data-q', 'final'); }
        }

        // --- ACTIONS ---
        async function adjScore(side, amt) {
            const el = document.getElementById('live-' + side);
            el.value = parseInt(el.value) + amt;
            syncLive();
        }
        async function syncLive() {
            const t = document.getElementById('live-top').value;
            const l = document.getElementById('live-left').value;
            await apiCall('/api/admin/live-score', { top:t, left:l });
        }
        async function submitToQuarter() {
            const q = document.getElementById('set-quarter-btn').getAttribute('data-q');
            if(!confirm(`Set current live score as ${q.toUpperCase()} Final?`)) return;
            document.getElementById(`s-${q}-top`).value = document.getElementById('live-top').value;
            document.getElementById(`s-${q}-left`).value = document.getElementById('live-left').value;
            await saveScores();
        }

        function renderQuickChips(squares) {
            const counts = {};
            squares.forEach(s => counts[s.name] = (counts[s.name] || 0) + 1);
            const sortedNames = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 15);
            const con = document.getElementById('quick-fill-chips');
            con.innerHTML = '';
            sortedNames.forEach(name => {
                const chip = document.createElement('div');
                chip.className = 'name-chip';
                chip.innerText = name;
                chip.onclick = () => selectChip(chip, name);
                con.appendChild(chip);
            });
        }

        function selectChip(el, name) {
            if(activeQuickName === name) {
                activeQuickName = null;
                el.classList.remove('active');
                document.getElementById('custom-assign-name').value = '';
            } else {
                document.querySelectorAll('.name-chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                activeQuickName = name;
                document.getElementById('custom-assign-name').value = name;
            }
        }

        function renderGrid(data) {
            const grid = document.getElementById('mini-grid');
            grid.innerHTML = ''; 
            addCell(grid, '', 'header');
            data.topHeaders.forEach(h => addCell(grid, h, 'header'));
            for(let r=0; r<10; r++) {
                addCell(grid, data.leftHeaders[r], 'header'); 
                for(let c=0; c<10; c++) {
                    const taken = data.squares.find(s=>s.row===r && s.col===c);
                    const div = document.createElement('div');
                    if(taken) {
                        div.className = 'cell taken';
                        div.innerText = taken.name.substring(0,2);
                        div.title = taken.name;
                        div.onclick = () => handleEdit(r, c, taken.name);
                    } else {
                        div.className = 'cell';
                        div.onclick = () => handleAssign(r, c);
                    }
                    grid.appendChild(div);
                }
            }
        }

        function renderStats(squares, cost) {
            const counts = {};
            const paidStatus = {};
            squares.forEach(s => {
                counts[s.name] = (counts[s.name] || 0) + 1;
                if (paidStatus[s.name] === undefined) paidStatus[s.name] = true;
                if (s.is_paid !== 1) paidStatus[s.name] = false;
            });
            
            let html = `<table class="stats"><tr><th>Name</th><th>Count</th><th>Owes ($${cost})</th><th>Paid?</th></tr>`;
            let totalSq = 0;
            
            Object.keys(counts).sort().forEach(name => {
                const num = counts[name];
                const isPaid = paidStatus[name];
                const badge = isPaid ? '‚úÖ' : '‚ùå';
                const badgeClass = isPaid ? 'paid' : 'unpaid';
                const safeName = name.replace(/'/g, "\\'"); 
                totalSq += num;
                html += `<tr>
                    <td>${name}</td>
                    <td>${num}</td>
                    <td>$${num * cost}</td>
                    <td><span class="status-badge ${badgeClass}" onclick="togglePay('${safeName}')">${badge}</span></td>
                </tr>`;
            });
            const totalMoney = totalSq * cost;
            html += `<tr><td><strong>TOTAL</strong></td><td><strong>${totalSq} / 100</strong></td><td><strong>$${totalMoney}</strong></td><td>-</td></tr></table>`;
            document.getElementById('stats-container').innerHTML = html;
            
            const qPay = (totalMoney / 4).toFixed(2);
            document.getElementById('payout-info').innerHTML = `
                <strong>Estimated Payouts (25% split):</strong><br>
                Q1: $${qPay} &bull; Q2: $${qPay} &bull; Q3: $${qPay} &bull; Final: $${qPay}
            `;
        }

        function addCell(c, t, cls) {
            const d = document.createElement('div'); d.className='cell '+cls; d.innerText=t; c.appendChild(d);
        }

        async function handleAssign(r, c) {
            const manualName = document.getElementById('custom-assign-name').value;
            let nameToUse = activeQuickName || manualName;
            if (!nameToUse) {
                nameToUse = prompt("Assign square to:");
                if (!nameToUse) return;
            }
            await apiCall('/api/admin/assign', { row:r, col:c, name: nameToUse });
        }
        
        async function handleEdit(r, c, oldName) {
            const newName = prompt("Edit Name (Clear to delete):", oldName);
            if (newName === null) return; 
            if (newName.trim() === "") { if(confirm("Delete?")) await apiCall('/api/admin/clear', { row:r, col:c }); } 
            else { await apiCall('/api/admin/rename', { row:r, col:c, name: newName }); }
        }

        async function saveSettings() {
            await apiCall('/api/admin/teams', { 
                teamTop: document.getElementById('team-top').value,
                colorTop: document.getElementById('color-top').value,
                teamLeft: document.getElementById('team-left').value,
                colorLeft: document.getElementById('color-left').value
            });
            await apiCall('/api/admin/settings', { cost: document.getElementById('cost-input').value });
            alert("Settings Saved");
        }

        async function saveScores() {
            const scores = {};
            ['q1','q2','q3','final'].forEach(q => {
                scores[q] = { top: document.getElementById(`s-${q}-top`).value, left: document.getElementById(`s-${q}-left`).value };
            });
            await apiCall('/api/admin/scores', scores);
            alert("Scores Updated");
        }

        async function clearScores() {
            if(!confirm("Clear all scores?")) return;
            ['q1','q2','q3','final'].forEach(q => {
                document.getElementById(`s-${q}-top`).value = "";
                document.getElementById(`s-${q}-left`).value = "";
            });
            await saveScores();
        }

        async function togglePay(name) { await apiCall('/api/admin/toggle-pay', { name }); }
        async function apiCall(url, body) {
            body.password = storedPass;
            await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            loadAdmin();
        }

        async function toggleLock(l) { await apiCall('/api/admin/lock', {locked:l}); }
        async function randomize() { if(confirm("Randomize #s?")) await apiCall('/api/admin/randomize', {}); }
        async function resetHeaders() { if(confirm("Reset #s to ?")) await apiCall('/api/admin/clear-headers', {}); }
        async function resetBoard() { if(prompt("Type RESET")==='RESET') await apiCall('/api/admin/reset-board', {}); }
    </script>
</body>
</html>
